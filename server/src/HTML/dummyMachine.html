
<!DOCTYPE html>
<html>
<head>
  	<meta charset="utf-8">
</head>
<body>
	<!-- https://www.google.com/search?q=steel+background&tbm=isch&ved=2ahUKEwizk6Wl9Nf3AhUBgqQKHdTxD_4Q2-cCegQIABAA&oq=steel+background&gs_lcp=CgNpbWcQAzIFCAAQgAQyBAgAEB4yBAgAEB4yBAgAEB4yBAgAEB4yBAgAEB4yBAgAEB4yBAgAEB4yBAgAEB4yBAgAEB46BwgjEO8DECc6BAgAEEM6BggAEAgQHjoECAAQGDoKCCMQ7wMQ6gIQJzoICAAQgAQQsQM6CwgAEIAEELEDEIMBUKkEWM4wYNMyaAlwAHgCgAFmiAHyDpIBBDMyLjKYAQCgAQGqAQtnd3Mtd2l6LWltZ7ABCsABAQ&sclient=img&ei=0-l7YvPdJYGEkgXU47_wDw&bih=746&biw=1536&rlz=1C1UEAD_deDE973DE973#imgrc=iNhIJ7hRuELB7M --> 
	<svg id="hole-background" width="100%" height="600px" xmlns="http://www.w3.org/2000/svg">
		<image preserveAspectRatio="none" id="steel-background" width="100%" height="600px" href="/images/steel" alt="steel-background"></image>
	</svg>
	<div id="display" width="100%"></div>
</body>
</html>
<style type="text/css">
	#hole-background {
		position: absolute
	}
	</style>
<script>
	const display = document.getElementById("display");
	const holeBackground = document.getElementById('hole-background')
	const background = document.getElementById("steel-background")
	
	const HOLE_POSITIONS = [
		[0.2, 0.2],
		[0.8, 0.2],
		[0.2, 0.8],
		[0.8, 0.8]
	]
	
	var rect = background.getBoundingClientRect();
	const screenWidth = rect.width
	const screenHeight = rect.height

	HOLE_POSITIONS.forEach((hole, index) => {
		const circle = createHole(hole[0] * screenWidth, hole[1] * screenHeight, index)
		holeBackground.appendChild(circle)
	})
	
	const screw = createScrew()
	const hand = createHand()
	holeBackground.appendChild(screw)
	holeBackground.appendChild(hand)
	
	
	function sendSensorData() {
		var xhr = new XMLHttpRequest();
		xhr.open('POST', '/machine');
		xhr.setRequestHeader("Content-Type", "application/json");
		xhr.onreadystatechange = function() { // Call a function when the state changes.
			if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
				DisplayState(JSON.parse(this.response))
				setTimeout(sendSensorData,3);
			}
		}
		xhr.send(JSON.stringify({}));
	}
	
	function DisplayState(state) {

		display.innerText = JSON.stringify(state)
		
		if(state.right){
			DisplayRightHand(state.right)
		}
		
		if(state.screw){
			DisplayScrew(state.screw)
			if (state.commandQueue) {
				const fingerNumber = state.commandQueue.pop()
				
			}
		}

	}
	
	function DisplayRightHand(rightHandState){
		moveSvgImageCentered(hand, rightHandState.pos.x, rightHandState.pos.y)
		hand.setAttribute('href', rightHandState.grap ? '/images/crosshair_green' : '/images/crosshair_red')
	}
	
	
	function DisplayScrew(screwState){
		moveSvgImageCentered(screw, screwState.x, screwState.y)
	}
	
	function moveSvgImageCentered(svgImage, x, y) {
		var posx = (1-x) * screenWidth
		var posy = y * screenHeight
		const rect = svgImage.getBoundingClientRect()
		svgImage.setAttribute('x', posx - rect.width / 2.0)
		svgImage.setAttribute('y', posy - rect.height / 2.0)
	}
	
	function createHole(posX, posY, id){
		const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle')
		circle.setAttribute('cx', posX)
		circle.setAttribute('cy', posY)
		circle.setAttribute('r', 15)
		circle.setAttribute('z', 1)
		circle.setAttribute('id', 'hole' + id)
		circle.setAttribute('fill', "#4449")
		return circle
	}
	
	function createHand(){
		var hand = document.createElementNS('http://www.w3.org/2000/svg', 'image')
		hand.setAttribute('width', 41)
		hand.setAttribute('height', 41)
		hand.setAttribute('id', 'hand')
		hand.setAttribute('href', '/images/crosshair_red')
		return hand
	}

	function createScrew(){
		const screw = document.createElementNS('http://www.w3.org/2000/svg', 'image')
		screw.setAttribute("width", 50)
		screw.setAttribute("height", 50)
		screw.setAttribute("href", "/images/screwhead")
		return screw
	}

	sendSensorData()
</script>